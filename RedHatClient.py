import config
import requests


class RedHatClient:
    def __init__(self, base_url=config.red_hat_api_base_url,
                 product=None,
                 pprint=True,
                 adv=False,
                 **kwargs
                 ):
        self.response_format = ".json"
        self.product = product
        self.pprint = pprint
        self.adv = adv
        self.kwargs = kwargs

        self.response_json = None
        self.base_url = base_url

    def get_system_all_cve(self):
        if self.product is None:
            param_product = ""
        else:
            param_product = "?product=" + self.product
            param_product = param_product.replace(" ", "%20")

        parameter_list = []
        for name, value in self.kwargs.items():
            if value is not None:
                parameter_list.append(f"?{name}={value}")

        additional_parameters = "".join(parameter_list)

        url = self.base_url + "/cve" + self.response_format + additional_parameters + param_product

        response = requests.get(url)
        self.response_json = response.json()
        if self.pprint:
            self.pprint_results()

        return response.json()

    def pprint_results(self, only_with_advisories=False):
        for cve in self.response_json:
            if not only_with_advisories and cve['advisories'] == []:
                continue
            print(f"CVE: {cve['CVE']},",
                  f"severity: {cve['severity']}",
                  f"short description: {cve['bugzilla_description']}",
                  "RHSA entries regarding CVE:", sep="\n", end="\n")
            for errata in cve["advisories"]:
                print(f"\t{errata} => https://access.redhat.com/errata/{errata}")
            print("\n", "=" * 10, "\n")
